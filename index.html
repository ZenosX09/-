<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏û‡∏£‡∏™‡πå‡πÄ‡πÄ‡∏ü‡∏ô‡∏Ç‡∏≠‡∏á‡∏î‡∏£‡∏µ‡∏°‡∏°‡∏µ‡πà</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;900&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#ff9a9e; --bg2:#fad0c4;
      --accent:#ff6f91; --accent-dark:#ff3f6f;
      --card:#ffffff; --shadow: 0 18px 60px rgba(0,0,0,0.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Kanit',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased;color:#222}
    canvas#bgCanvas{position:fixed;inset:0;z-index:1;pointer-events:none}

    /* App layout */
    #wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;position:relative;overflow:hidden}
    #app{width:1100px;max-width:calc(100% - 48px);display:flex;gap:28px;z-index:10;align-items:flex-start}

    /* Left card */
    .card{width:420px;background:linear-gradient(180deg,rgba(255,255,255,0.98),#fff);border-radius:18px;padding:22px;box-shadow:var(--shadow);position:relative;overflow:visible}
    .logo{width:68px;height:68px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:22px;margin:0 auto 10px;box-shadow:0 12px 30px rgba(255,111,145,0.18)}
    h1{margin:6px 0 0;font-size:20px;text-align:center;font-family:'Playfair Display', serif}
    .subtitle{font-size:13px;color:#666;text-align:center;margin-bottom:12px}

    .display{font-size:26px;letter-spacing:10px;padding:14px;border-radius:12px;background:linear-gradient(180deg,#fff,#fff);border:1px solid #f0f0f0;min-height:44px;display:flex;align-items:center;justify-content:center}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
    .key{background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;border:none;padding:14px;border-radius:12px;font-size:18px;cursor:pointer;box-shadow:0 12px 28px rgba(255,111,145,0.18);transition:transform .12s, box-shadow .12s, filter .12s;font-family:'Kanit'}
    .key:hover{filter:brightness(1.03);transform:translateY(-4px)}
    .key:active{transform:translateY(2px)}
    .key.gray{background:#f0f0f0;color:#333;box-shadow:none}
    .message{margin-top:12px;color:var(--accent-dark);font-weight:700;min-height:22px;text-align:center}

    .reply-box{margin-top:14px;background:linear-gradient(180deg,#fff,#fff);border-radius:14px;padding:12px;min-height:220px;max-height:320px;overflow:auto;text-align:center;border:1px solid #f3f3f3;box-shadow:inset 0 -6px 12px rgba(0,0,0,0.02);display:none}
    .reply-item{display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#fff,#fff);padding:12px 14px;border-radius:12px;margin:10px auto;color:#333;font-weight:800;box-shadow:0 8px 20px rgba(0,0,0,0.06);opacity:0;transform:translateY(10px);transition:opacity .45s, transform .45s;max-width:86%}
    .reply-item.show{opacity:1;transform:translateY(0)}
    .hint{font-size:13px;color:#888;margin-top:8px;text-align:center}

    .choice-wrap{display:flex;justify-content:center;gap:18px;margin-top:12px}
    .btn{position:relative;padding:12px 26px;border-radius:12px;border:none;cursor:pointer;font-weight:900;margin:0 8px;overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,0.08);transition:transform .12s, box-shadow .12s}
    .btn.yes{background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#fff}
    .btn.no{background:#f0f0f0;color:#333}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(255,255,255,0.35);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(4);opacity:0}}
    .heart-pop{position:absolute;left:50%;transform:translateX(-50%) scale(0);top:18px;width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#ff6f91,#ff3f6f);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:20px;opacity:0;transition:transform .45s cubic-bezier(.2,.9,.2,1),opacity .45s}
    .heart-pop.show{transform:translateX(-50%) translateY(-36px) scale(1);opacity:1}
    .small-muted{font-size:12px;color:#999;margin-top:8px;text-align:center}

    /* Gallery */
    .gallery{width:620px;min-height:640px;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:flex-start}
    .carousel-wrap{width:100%;height:620px;border-radius:18px;overflow:hidden;position:relative;box-shadow:var(--shadow);background:linear-gradient(180deg,#fff6f8,#fff0fb);display:flex;align-items:center;justify-content:center}
    .carousel{width:92%;height:92%;position:relative;display:flex;align-items:center;justify-content:center;border-radius:14px;overflow:hidden}
    .carousel img{position:absolute;width:100%;height:100%;object-fit:cover;border-radius:14px;opacity:0;transform:scale(.98) translateY(12px);transition:opacity .9s ease, transform .9s ease, filter .6s;box-shadow:0 30px 80px rgba(0,0,0,0.18)}
    .carousel img.show{opacity:1;transform:scale(1) translateY(0);filter:drop-shadow(0 12px 40px rgba(255,111,145,0.08))}
    .carousel img:hover{transform:scale(1.02);transition:transform .6s}
    .caption{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.95);padding:10px 16px;border-radius:12px;font-weight:800;color:var(--accent-dark);box-shadow:0 10px 30px rgba(0,0,0,0.08);z-index:40;font-family:'Playfair Display', serif}
    .arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.95);border-radius:50%;width:64px;height:64px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 14px 40px rgba(0,0,0,0.12);z-index:45;font-weight:900}
    .arrow.left{left:18px} .arrow.right{right:18px}
    .dots{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:45}
    .dot{width:12px;height:12px;border-radius:50%;background:rgba(0,0,0,0.12);cursor:pointer;transition:transform .18s, background .18s}
    .dot.active{background:var(--accent);transform:scale(1.2)}
    .progress{position:absolute;left:0;bottom:0;height:6px;background:linear-gradient(90deg,var(--accent),var(--accent-dark));width:0%;z-index:46;transition:width linear}

    /* Lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999}
    .lightbox img{max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 30px 80px rgba(0,0,0,0.6)}

    /* Finale overlay */
    .final-overlay{position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:10000;flex-direction:column;color:#fff}
    .final-text{font-family:'Playfair Display', serif;font-size:84px;font-weight:900;text-align:center;letter-spacing:2px;opacity:0;transform:scale(.9);transition:all .9s cubic-bezier(.2,.9,.2,1)}
    .final-text.show{opacity:1;transform:scale(1)}
    .flower-container{position:relative;width:100%;height:0;pointer-events:none}
    .flower{position:absolute;bottom:10%;width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:#ff3f6f;transform:translateY(40px) scale(0.2) rotate(-10deg);opacity:0;transition:transform .9s cubic-bezier(.2,.9,.2,1), opacity .9s;box-shadow:0 12px 30px rgba(0,0,0,0.18);background: radial-gradient(circle at 30% 30%, #fff, #ffd6e0)}
    .flower.show{transform:translateY(0) scale(1) rotate(0deg);opacity:1}

    /* Flower popup (SVG) */
    .flower-popup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.88), rgba(0,0,0,0.95));z-index:12000;overflow:hidden}
    .flower-popup__content{position:relative;width:100%;max-width:1100px;padding:36px 20px;box-sizing:border-box;display:flex;flex-direction:column;align-items:center;gap:18px}
    .flower-popup__close{position:absolute;right:18px;top:18px;background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer;opacity:0.95}
    .flower-popup__title{margin:0;color:#fff;font-family:'Playfair Display',serif;font-size:64px;text-align:center;text-shadow:0 12px 30px rgba(0,0,0,0.6)}
    .flower-container-svg{position:relative;width:100%;height:260px;pointer-events:none;overflow:visible}
    .flower-svg{position:absolute;bottom:-40px;width:96px;height:96px;transform:translateY(0) scale(0.2) rotate(-10deg);opacity:0;transition:transform .9s cubic-bezier(.2,.9,.2,1), opacity .9s;filter:drop-shadow(0 12px 30px rgba(0,0,0,0.45))}
    .flower-svg.show{transform:translateY(-180px) scale(1) rotate(0deg);opacity:1}
    .flower-svg.float{animation: floatUp 3.6s ease-in-out infinite}
    @keyframes floatUp{0%{transform:translateY(-180px) translateX(0) scale(1)}50%{transform:translateY(-200px) translateX(6px) scale(1.02)}100%{transform:translateY(-180px) translateX(0) scale(1)}}

    /* Music control */
    .music-control {
      position:fixed; right:18px; bottom:18px; z-index:12001;
      background:linear-gradient(90deg,var(--accent),var(--accent-dark)); color:#fff;
      border:none; padding:10px 14px; border-radius:999px; box-shadow:0 12px 30px rgba(0,0,0,0.18); cursor:pointer; font-weight:800;
    }
    .music-control.paused { background:#fff; color:var(--accent-dark); border:1px solid rgba(0,0,0,0.06); }

    @media (max-width:1200px){ #app{flex-direction:column;align-items:center} .gallery{width:92%} .card{width:92%} .carousel img{height:60vh} .final-text{font-size:48px} .flower-popup__title{font-size:40px} .flower-svg{width:64px;height:64px} .flower-container-svg{height:180px} }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>

  <div id="wrap">
    <div id="app">
      <!-- Left: keypad + reply -->
      <div class="card" id="controlCard">
        <div class="logo">‚ô•</div>
        <h1>‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ôValentine‡∏ô‡∏∞‡∏Ñ‡∏∞</h1>
        <div class="subtitle">‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ô‡∏∞‡∏à‡πâ‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏≠‡∏Å‡∏Å‡∏Å</div>

        <div class="display" id="display"></div>

        <div class="keypad" id="keypad">
          <button class="key" onclick="pressNum(1,event)">1</button>
          <button class="key" onclick="pressNum(2,event)">2</button>
          <button class="key" onclick="pressNum(3,event)">3</button>
          <button class="key" onclick="pressNum(4,event)">4</button>
          <button class="key" onclick="pressNum(5,event)">5</button>
          <button class="key" onclick="pressNum(6,event)">6</button>
          <button class="key" onclick="pressNum(7,event)">7</button>
          <button class="key" onclick="pressNum(8,event)">8</button>
          <button class="key" onclick="pressNum(9,event)">9</button>
          <button class="key gray" onclick="clearNum(event)">C</button>
          <button class="key" onclick="pressNum(0,event)">0</button>
          <button class="key gray" onclick="checkPass(event)">OK</button>
        </div>

        <div class="message" id="message"></div>

        <div class="reply-box" id="replyBox"></div>
        <div class="hint" id="hint" style="display:none">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Yes ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏£‡∏±‡∏Å‡∏î‡∏£‡∏µ‡∏°‡∏°‡∏µ‡πà ‡∏Å‡∏îNo ‡∏ñ‡πâ‡∏≤‡πÄ‡πÄ‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏â‡∏±‡∏ô</div>

        <div id="heartPop" class="heart-pop">‚ô•</div>
        <div class="small-muted"></div>
      </div>

      <!-- Right: gallery -->
      <div class="gallery">
        <div class="carousel-wrap" id="carouselWrap" style="display:none">
          <div class="carousel" id="carousel">
            <div class="meta" id="metaLabel" style="position:absolute;left:18px;top:18px;background:rgba(255,255,255,0.9);padding:8px 12px;border-radius:12px;font-weight:800;color:var(--accent-dark);box-shadow:0 8px 20px rgba(0,0,0,0.06);z-index:40">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡∏î‡∏£‡∏µ‡∏°‡∏°‡∏µ‡πà‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏¥‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¥‡πâ‡∏ö‡∏ö</div>

            <!-- 8 images -->
            <img src="‡∏Ñ‡∏π‡πà.jfif" alt="1" class="show" loading="lazy">
            <img src="‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤.jfif" alt="2" loading="lazy">
            <img src="‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà.jfif" alt="3" loading="lazy">
            <img src="‡πÄ‡∏ã‡∏ô.jfif" alt="4" loading="lazy">
            <img src="‡πÄ‡πÄ‡∏ß‡πâ‡∏ô.jfif" alt="5" loading="lazy">
            <img src="‡∏á‡∏≤‡∏ô.jfif" alt="6" loading="lazy">
            <img src="‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î.jfif" alt="7" loading="lazy">
            <img src="‡∏ô‡∏®‡∏ó.jfif" alt="8" loading="lazy">

            <div class="caption" id="loveText">‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢ üíò</div>
            <div class="arrow left" id="prevBtn" aria-label="Previous">‚óÄ</div>
            <div class="arrow right" id="nextBtn" aria-label="Next">‚ñ∂</div>
            <div class="dots" id="dots"></div>
            <div class="progress" id="progressBar"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" onclick="closeLightbox(event)">
    <img id="lightboxImg" src="" alt="enlarged">
  </div>

  <!-- Finale overlay -->
  <div class="final-overlay" id="finalOverlay">
    <div class="final-text" id="finalText">‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÜ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÜ‡πÄ‡πÄ‡∏ï‡πà‡πÄ‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏£‡∏µ‡∏ö‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏≤‡πÄ‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡πÄ‡∏•‡∏∞‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏ô‡∏∞‡πÄ‡∏ß‡πâ‡∏¢‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏ó‡∏µ‡πà‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡πÄ‡∏ó‡∏ô‡πÄ‡πÄ‡∏•‡∏∞‡∏∞‡∏â‡∏±‡∏ô‡∏£‡∏±‡∏Å‡πÄ‡πÄ‡∏Å‡∏°‡∏≤‡∏Å‡∏ô‡∏∞‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ß‡∏µ‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏Å‡πá‡πÄ‡∏ñ‡∏≠‡∏∞‡πÄ‡πÄ‡∏ï‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∏‡πâ‡∏ö‡πÜ‡∏ô‡∏∞‡∏à‡πâ‡∏∞‡∏≠‡∏µ‡∏≠‡πâ‡∏ß‡∏ô ‚ù§Ô∏è</div>
    <div class="flower-container" id="flowerContainer"></div>
  </div>

  <!-- Flower popup with inline SVG flowers -->
  <div id="flowerPopup" class="flower-popup" aria-hidden="true" onclick="closeFlowerPopup(event)">
    <div class="flower-popup__content" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
      <button class="flower-popup__close" onclick="closeFlowerPopup(event)" aria-label="‡∏õ‡∏¥‡∏î">‚úï</button>
      <h2 id="flowerPopupText" class="flower-popup__title">‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÜ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÜ‡πÄ‡πÄ‡∏ï‡πà‡πÄ‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏£‡∏µ‡∏ö‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏≤‡πÄ‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡πÄ‡∏•‡∏∞‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏ô‡∏∞‡πÄ‡∏ß‡πâ‡∏¢‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏ó‡∏µ‡πà‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡πÄ‡∏ó‡∏ô‡πÄ‡πÄ‡∏•‡∏∞‡∏∞‡∏â‡∏±‡∏ô‡∏£‡∏±‡∏Å‡πÄ‡πÄ‡∏Å‡∏°‡∏≤‡∏Å‡∏ô‡∏∞‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ß‡∏µ‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏Å‡πá‡πÄ‡∏ñ‡∏≠‡∏∞‡πÄ‡πÄ‡∏ï‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∏‡πâ‡∏ö‡πÜ‡∏ô‡∏∞‡∏à‡πâ‡∏∞‡∏≠‡∏µ‡∏≠‡πâ‡∏ß‡∏ô ‚ù§Ô∏è</h2>
      <div id="flowerContainer" class="flower-container-svg" aria-hidden="true"></div>
    </div>
  </div>

  <!-- Music control button (visible so user can start/stop) -->
  <button id="musicControl" class="music-control" aria-pressed="false">‡πÄ‡∏û‡∏•‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î</button>

  <!-- audio element (looping) -->
  <audio id="bgMusic" preload="auto" loop>
    <source src="Love.mp3" type="audio/mpeg">
  </audio>

  <script>
    /* -------------------------
       Core state & audio persistence
       ------------------------- */
    const bgMusic = document.getElementById('bgMusic');
    const musicControl = document.getElementById('musicControl');

    // Ensure music loops and starts muted if autoplay blocked; set gentle default volume
    bgMusic.loop = true;
    bgMusic.volume = 0.28;

    // Track whether user explicitly toggled music
    let userToggledMusic = false;

    // Try to play music on first meaningful user gesture; if blocked, show control button
    function tryPlayMusic() {
      bgMusic.play().then(()=> {
        musicControl.classList.remove('paused');
        musicControl.textContent = '‡πÄ‡∏û‡∏•‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î';
        musicControl.setAttribute('aria-pressed','true');
      }).catch(()=> {
        // Autoplay blocked ‚Äî show control in "paused" state so user can tap to start
        musicControl.classList.add('paused');
        musicControl.textContent = '‡πÄ‡∏û‡∏•‡∏á: ‡∏õ‡∏¥‡∏î (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°)';
        musicControl.setAttribute('aria-pressed','false');
      });
    }
    document.addEventListener('click', tryPlayMusic, { once: true });
    document.addEventListener('keydown', tryPlayMusic, { once: true });

    // Music control toggle (visible, so user can always start/stop)
    musicControl.addEventListener('click', () => {
      if (bgMusic.paused) {
        bgMusic.play().catch(()=>{});
        musicControl.classList.remove('paused');
        musicControl.textContent = '‡πÄ‡∏û‡∏•‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î';
        musicControl.setAttribute('aria-pressed','true');
        userToggledMusic = true;
      } else {
        bgMusic.pause();
        musicControl.classList.add('paused');
        musicControl.textContent = '‡πÄ‡∏û‡∏•‡∏á: ‡∏õ‡∏¥‡∏î';
        musicControl.setAttribute('aria-pressed','false');
        userToggledMusic = true;
      }
    });

    // Resume music when page becomes visible again (if user hasn't explicitly paused)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && !bgMusic.paused && !userToggledMusic) {
        // already playing; nothing
      } else if (document.visibilityState === 'visible' && bgMusic.paused && !userToggledMusic) {
        // try to resume automatically
        bgMusic.play().catch(()=>{});
      }
    });

    // Prevent accidental pauses: ensure no code path pauses bgMusic
    // (We will explicitly call bgMusic.play() at key transitions to ensure continuity.)

    /* -------------------------
       Rest of UI (unchanged behavior) ‚Äî keypad, replies, carousel, finale, flower popup
       (kept concise here; full logic included so music persists across all transitions)
       ------------------------- */

    const correctCode = "181267";
    let inputCode = "";
    let noCount = 0;
    let yesCount = 0;
    let carouselInterval = null;
    const autoplayDelay = 4200;

    // Finale tracking
    let slidesShownCount = 0;
    let lastShownIndex = -1;
    let finaleTriggered = false;

    // Preload images
    const carouselImgs = Array.from(document.querySelectorAll('.carousel img'));
    carouselImgs.forEach(i => { const img = new Image(); img.src = i.src; });

    function clickBeep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 700;
        g.gain.value = 0.02;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 60);
      }catch(e){}
    }

    /* Keypad */
    function pressNum(n, e){
      if(inputCode.length >= 8) return;
      inputCode += String(n);
      document.getElementById('display').innerText = '‚Ä¢'.repeat(inputCode.length);
      document.getElementById('message').innerText = "";
      pulseButton(e?.currentTarget);
      createRipple(e?.currentTarget, e);
      clickBeep();
      // ensure music is playing when user interacts
      bgMusic.play().catch(()=>{});
    }
    function clearNum(e){
      inputCode = "";
      document.getElementById('display').innerText = "";
      document.getElementById('message').innerText = "";
      pulseButton(e?.currentTarget);
      createRipple(e?.currentTarget, e);
      clickBeep();
      bgMusic.play().catch(()=>{});
    }
    function checkPass(e){
      pulseButton(e?.currentTarget);
      createRipple(e?.currentTarget, e);
      clickBeep();
      bgMusic.play().catch(()=>{});
      if(inputCode === correctCode){
        showChoiceInterface();
      } else {
        document.getElementById('message').innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î‡∏ô‡∏∞‡∏à‡πä‡∏∞ ‡∏≠‡∏µ‡∏≠‡πâ‡∏ß‡∏ô‡∏ôüòè ‡∏Ñ‡∏¥‡∏î‡πÜ‡πÜ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏£‡∏ô‡πâ‡∏≠‡∏≠‡∏ß‡πâ‡∏≤‡∏¢‡πÜ‡πÜ‡πÜ";
        shakeElement(document.getElementById('controlCard'));
        inputCode = "";
        document.getElementById('display').innerText = "";
      }
    }

    /* Choice & Replies */
    function showChoiceInterface(){
      const replyBox = document.getElementById('replyBox');
      replyBox.style.display = 'block';
      replyBox.innerHTML = '';
      document.getElementById('hint').style.display = 'block';
      const keypad = document.getElementById('keypad');
      if(keypad) keypad.remove();
      const existing = document.querySelector('.choice-wrap');
      if(existing) existing.remove();
      const controlCard = document.getElementById('controlCard');
      const choiceWrap = document.createElement('div');
      choiceWrap.className = 'choice-wrap';
      choiceWrap.innerHTML = `
        <button class="btn yes" id="yesBtn" onclick="yesBox(event)">Yes</button>
        <button class="btn no" id="noBtn" onclick="noBox(event)">No</button>
      `;
      controlCard.appendChild(choiceWrap);
      // keep music playing
      bgMusic.play().catch(()=>{});
    }

    function appendReply(text, type='yes'){
      const box = document.getElementById('replyBox');
      if(!box) return;
      const item = document.createElement('div');
      item.className = 'reply-item';
      item.innerText = text;
      if(type === 'yes') item.style.borderLeft = '6px solid rgba(255,111,145,0.18)';
      else item.style.borderLeft = '6px solid rgba(150,150,150,0.12)';
      box.appendChild(item);
      box.scrollTop = box.scrollHeight;
      setTimeout(()=> item.classList.add('show'), 20);
      item.animate([{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:260});
      bgMusic.play().catch(()=>{});
    }

    function noBox(e){
      const msgs = [
        "‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏Å‡πá‡πÄ‡πÄ‡∏•‡πâ‡∏ß‡πÄ‡πÄ‡∏ï‡πà‡πÄ‡πÄ‡∏Å‡πÄ‡∏ñ‡∏≠‡∏∞‡∏á‡∏≠‡∏ô‡πÄ‡πÄ‡∏•‡∏∞üíî",
        "‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡∏Å‡∏Å‡∏î Yes ‡πÑ‡∏î‡πâ‡πÄ‡πÄ‡∏•‡πâ‡∏ß‡∏ß‡πÄ‡∏î‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏¢ üò≠",
        "‡∏Å‡∏î No ‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ‡πÄ‡∏ñ‡∏≠‡∏∞ ‡πÄ‡∏ä‡∏≠‡∏∞‡∏∞ üòâ",
        "‡πÄ‡πÄ‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏â‡∏±‡∏ô‡∏£‡∏±‡∏Å‡πÄ‡πÄ‡∏Å‡∏ô‡∏∞‡πÄ‡πÄ‡∏ï‡πà‡∏ß‡πà‡∏≤üòè",
        "‡∏Å‡∏îYes ‡πÄ‡∏ñ‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏ÅüòÖ"
      ];
      appendReply(msgs[noCount % msgs.length], 'no');
      noCount++;
      pulseButton(e?.currentTarget);
      createRipple(e?.currentTarget, e);
      e?.currentTarget.classList.add('shake');
      setTimeout(()=> e?.currentTarget.classList.remove('shake'), 360);
      clickBeep();
      bgMusic.play().catch(()=>{});
    }

    function yesBox(e){
      const msgs = [
        "‡πÄ‡πÄ‡∏≠‡∏ö‡∏£‡∏±‡∏Å‡∏â‡∏±‡∏ô‡∏´‡∏£‡∏≠‡πÄ‡∏Ç‡∏¥‡∏ô‡∏ô‡∏∞ üíï",
        "‡∏Å‡∏î‡∏≠‡∏µ‡∏Å‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÄ‡πÄ‡∏•‡∏∞‡∏∞ ‚ù§Ô∏è",
        "‡∏£‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏Å‡∏±‡∏ô‡∏à‡πâ‡∏∞‡∏≠‡∏µ‡∏≠‡πâ‡∏ß‡∏ô üòò",
        "‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÄ‡πÄ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ‡∏£‡∏µ‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏≤‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏•‡∏∞! üéâ",
        "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏ï‡∏•‡∏≠‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞ üíñ"
      ];
      appendReply(msgs[yesCount % msgs.length], 'yes');
      yesCount++;
      pulseButton(e?.currentTarget);
      createRipple(e?.currentTarget, e);
      const heartPop = document.getElementById('heartPop');
      heartPop.classList.add('show');
      setTimeout(()=> heartPop.classList.remove('show'), 900);
      clickBeep();
      bgMusic.play().catch(()=>{});

      if(yesCount >= 4){
        setTimeout(()=> {
          burstConfetti();
          setTimeout(showMemories, 900);
        }, 700);
      }
    }

    /* Ripple & helpers */
    function createRipple(el, e){
      if(!el) return;
      const rect = el.getBoundingClientRect();
      const r = document.createElement('span');
      r.className = 'ripple';
      const size = Math.max(rect.width, rect.height) * 1.2;
      r.style.width = r.style.height = size + 'px';
      const x = (e?.clientX ?? (rect.left + rect.width/2)) - rect.left - size/2;
      const y = (e?.clientY ?? (rect.top + rect.height/2)) - rect.top - size/2;
      r.style.left = x + 'px';
      r.style.top = y + 'px';
      el.appendChild(r);
      setTimeout(()=> r.remove(), 650);
    }
    function pulseButton(btn){
      if(!btn) return;
      btn.animate([{transform:'scale(1)'},{transform:'scale(.96)'},{transform:'scale(1)'}],{duration:180});
    }
    function shakeElement(el){
      if(!el) return;
      el.animate([{transform:'translateX(0)'},{transform:'translateX(-8px)'},{transform:'translateX(8px)'},{transform:'translateX(0)'}],{duration:360});
    }

    /* Confetti */
    const confettiCanvas = document.createElement('canvas');
    confettiCanvas.style.position='fixed'; confettiCanvas.style.inset='0'; confettiCanvas.style.pointerEvents='none'; confettiCanvas.style.zIndex=9999;
    document.body.appendChild(confettiCanvas);
    const cctx = confettiCanvas.getContext('2d');
    function resizeConfetti(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeConfetti); resizeConfetti();
    let confettiPieces = [];
    function burstConfetti(){
      confettiPieces = [];
      const colors = ['#ff6f91','#ffd166','#6fe7c4','#9ad0f5','#ff9ac1'];
      for(let i=0;i<160;i++){
        confettiPieces.push({ x: Math.random()*confettiCanvas.width, y: -20 - Math.random()*200, vx: (Math.random()-0.5)*10, vy: 2 + Math.random()*6, size: 6 + Math.random()*12, color: colors[Math.floor(Math.random()*colors.length)], rot: Math.random()*360, vr: (Math.random()-0.5)*12 });
      }
      animateConfetti();
      setTimeout(()=> confettiPieces = [], 4500);
    }
    function animateConfetti(){
      cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      confettiPieces.forEach((p,i)=>{
        p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.rot += p.vr;
        cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.rot * Math.PI/180); cctx.fillStyle = p.color; cctx.fillRect(-p.size/2, -p.size/2, p.size, p.size); cctx.restore();
      });
      if(confettiPieces.length) requestAnimationFrame(animateConfetti); else cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    }

    /* Background hearts */
    const bgCanvas = document.getElementById('bgCanvas'); const bctx = bgCanvas.getContext('2d');
    function resizeBg(){ bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeBg); resizeBg();
    let hearts = [];
    function spawnHeart(){ hearts.push({ x: Math.random()*bgCanvas.width, y: bgCanvas.height + 20, size: 10 + Math.random()*36, vy: 0.6 + Math.random()*1.6, vx: (Math.random()-0.5)*0.8, alpha: 0.6 + Math.random()*0.4, hue: 330 + Math.random()*20 }); }
    function drawHeart(x,y,s,alpha,hue){ bctx.save(); bctx.translate(x,y); bctx.scale(s/20,s/20); bctx.globalAlpha = alpha; bctx.fillStyle = `hsl(${hue},80%,65%)`; bctx.beginPath(); bctx.moveTo(0,0); bctx.bezierCurveTo(-12,-12,-20,6,0,20); bctx.bezierCurveTo(20,6,12,-12,0,0); bctx.fill(); bctx.restore(); }
    function animateBg(){ bctx.clearRect(0,0,bgCanvas.width,bgCanvas.height); if(Math.random() < 0.06) spawnHeart(); hearts.forEach((h,i)=>{ h.x += h.vx; h.y -= h.vy; h.alpha -= 0.0009; drawHeart(h.x,h.y,h.size,h.alpha,h.hue); if(h.y < -60 || h.alpha <= 0) hearts.splice(i,1); }); requestAnimationFrame(animateBg); }
    animateBg();

    /* Carousel with finale trigger */
    function showMemories(){
      if (finaleTriggered) return;
      document.getElementById('carouselWrap').style.display = 'flex';
      // ensure music continues
      bgMusic.play().catch(()=>{});
      const carouselEl = document.getElementById('carousel');
      const images = Array.from(carouselEl.querySelectorAll('img'));
      const texts = [
        "‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢ üíò",
        "‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏≤‡∏û‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ô‡∏∞‡πÄ‡∏ß‡πâ‡∏¢ üåé‚ù§Ô∏è",
        "‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÑ‡∏õ‡∏Å‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏∞üíï",
        "‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ò‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡πÄ‡∏ã‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏°‡∏≤‡∏Å‡∏Å",
        "‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏â‡∏±‡∏ô‡πÄ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏ñ‡πÑ‡∏õ‡∏™‡πà‡∏á‡πÄ‡πÄ‡∏Å‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡πÄ‡∏£‡∏Å‡∏Å‡πÉ‡∏ä‡πà‡πÜ‡πÜ‡πÑ‡∏ß‡πâ‡πÄ‡∏î‡∏∞‡∏â‡∏±‡∏ô‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏≠‡∏µ‡∏Å",
        "‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏ï8‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡πÄ‡∏•‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏™‡∏ô‡∏∏‡∏Å‡∏°‡∏≤‡∏Å‡∏Å",
        "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡πÄ‡∏Å‡∏•‡∏∞‡∏â‡∏±‡∏ô‡πÄ‡∏≠‡∏≤‡πÄ‡∏Ñ‡πâ‡∏Å‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏∂‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏∑‡∏≠‡πÄ‡∏Ñ‡πâ‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞",
        "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å‡πÄ‡πÄ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞‡πÄ‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏Å"
      ];
      let idx = 0;
      slidesShownCount = 0;
      lastShownIndex = -1;

      const dotsContainer = document.getElementById('dots');
      dotsContainer.innerHTML = '';
      images.forEach((_,i)=>{
        const d = document.createElement('div');
        d.className = 'dot' + (i===0 ? ' active' : '');
        d.onclick = ()=> goToSlide(i);
        dotsContainer.appendChild(d);
      });

      const progressBar = document.getElementById('progressBar');

      function startAutoplay(){
        stopAutoplay();
        const start = Date.now();
        progressBar.style.width = '0%';
        carouselInterval = setInterval(()=> goToSlide((idx + 1) % images.length), autoplayDelay);
        requestAnimationFrame(function progressLoop(){
          if(!carouselInterval) return;
          const elapsed = Date.now() - start;
          const pct = Math.min(100, (elapsed / autoplayDelay) * 100);
          progressBar.style.width = pct + '%';
          requestAnimationFrame(progressLoop);
        });
      }
      function stopAutoplay(){ if(carouselInterval){ clearInterval(carouselInterval); carouselInterval = null; } }

      function goToSlide(i){
        if(finaleTriggered) return;
        images.forEach(img=> img.classList.remove('show'));
        images[i].classList.add('show');
        idx = i;
        if (lastShownIndex !== i) {
          slidesShownCount++;
          lastShownIndex = i;
        }
        document.querySelectorAll('.dot').forEach((d,j)=> d.classList.toggle('active', j===i));
        document.getElementById('loveText').innerText = texts[i % texts.length];

        // trigger finale when all 8 unique slides have been shown
        if (slidesShownCount >= images.length && !finaleTriggered) {
          finaleTriggered = true;
          stopAutoplay();
          setTimeout(triggerFinale, 600);
          return;
        }

        stopAutoplay();
        startAutoplay();
      }

      window.nextSlide = ()=> goToSlide((idx + 1) % images.length);
      window.prevSlide = ()=> goToSlide((idx - 1 + images.length) % images.length);
      window.goToSlide = goToSlide;

      images.forEach(img=>{
        img.style.cursor = 'zoom-in';
        img.addEventListener('click', ()=> openLightbox(img.src));
      });

      // swipe support
      let startX=0, deltaX=0, isDown=false;
      carouselEl.addEventListener('touchstart', e=>{ isDown=true; startX=e.touches[0].clientX; stopAutoplay(); });
      carouselEl.addEventListener('touchmove', e=>{ if(!isDown) return; deltaX = e.touches[0].clientX - startX; });
      carouselEl.addEventListener('touchend', ()=>{ isDown=false; if(Math.abs(deltaX)>50){ if(deltaX<0) nextSlide(); else prevSlide(); } deltaX=0; });

      let mouseDown=false, mx=0;
      carouselEl.addEventListener('mousedown', e=>{ mouseDown=true; mx=e.clientX; stopAutoplay(); });
      window.addEventListener('mousemove', e=>{ if(!mouseDown) return; deltaX = e.clientX - mx; });
      window.addEventListener('mouseup', ()=>{ if(!mouseDown) return; mouseDown=false; if(Math.abs(deltaX)>80){ if(deltaX<0) nextSlide(); else prevSlide(); } deltaX=0; startAutoplay(); });

      images.forEach((img,i)=> img.classList.toggle('show', i===0));
      document.getElementById('loveText').innerText = texts[0];
      startAutoplay();

      const replyBoxEl = document.getElementById('replyBox');
      if(replyBoxEl) replyBoxEl.style.display = 'none';
      const choiceWrap = document.querySelector('.choice-wrap');
      if(choiceWrap) choiceWrap.style.display = 'none';
      const hintEl = document.getElementById('hint');
      if(hintEl) hintEl.style.display = 'none';
    }

    /* Finale */
    function triggerFinale(){
      const overlay = document.getElementById('finalOverlay');
      const finalText = document.getElementById('finalText');
      overlay.style.display = 'flex';
      setTimeout(()=> finalText.classList.add('show'), 60);
      // ensure music continues (do not pause)
      bgMusic.play().catch(()=>{});
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o1 = ctx.createOscillator(); const o2 = ctx.createOscillator();
        const g = ctx.createGain();
        o1.type='sine'; o2.type='triangle';
        o1.frequency.value = 440; o2.frequency.value = 660;
        g.gain.value = 0.02;
        o1.connect(g); o2.connect(g); g.connect(ctx.destination);
        o1.start(); o2.start();
        setTimeout(()=>{ o1.stop(); o2.stop(); ctx.close(); }, 600);
      }catch(e){}
      setTimeout(()=> popFlowers(), 900);
    }

    function popFlowers(){
      const container = document.getElementById('flowerContainer');
      container.innerHTML = '';
      const count = 14;
      for(let i=0;i<count;i++){
        const f = document.createElement('div');
        f.className = 'flower';
        const left = 6 + Math.random()*88;
        f.style.left = left + '%';
        f.innerHTML = 'üå∫';
        container.appendChild(f);
        setTimeout(()=> f.classList.add('show'), 120 * i);
        setTimeout(()=> {
          f.style.transition = 'transform 1.6s ease, opacity 1.6s';
          f.style.transform = `translateY(-160px) scale(1.1)`;
          f.style.opacity = '0';
        }, 2200 + i*80);
        setTimeout(()=> f.remove(), 4200 + i*80);
      }
    }

    /* Lightbox */
    function openLightbox(src){
      const lb = document.getElementById('lightbox');
      const lbImg = document.getElementById('lightboxImg');
      lbImg.src = src;
      lb.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      // keep music playing
      bgMusic.play().catch(()=>{});
    }
    function closeLightbox(e){
      if(e.target.id !== 'lightbox' && e.target.id !== 'lightboxImg') return;
      const lb = document.getElementById('lightbox');
      lb.style.display = 'none';
      document.body.style.overflow = '';
    }

    /* Flower SVG popup (inline) */
    function createFlowerSVGElement(colorPrimary = '#FF6F91', colorSecondary = '#FFD6E0') {
      const ns = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(ns, 'svg');
      svg.setAttribute('viewBox', '0 0 120 120');
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');
      svg.setAttribute('aria-hidden', 'true');

      const g = document.createElementNS(ns, 'g');
      g.setAttribute('transform', 'translate(60,60)');

      for (let i = 0; i < 5; i++) {
        const petal = document.createElementNS(ns, 'path');
        petal.setAttribute('d', 'M0,-6 C18,-34 46,-34 60,-6 C46,8 18,8 0,-6 Z');
        petal.setAttribute('fill', colorPrimary);
        petal.setAttribute('opacity', '0.98');
        petal.setAttribute('transform', `rotate(${i * 72}) scale(0.9)`);
        petal.setAttribute('style', 'transition: transform .9s, opacity .9s;');
        g.appendChild(petal);

        const inner = document.createElementNS(ns, 'path');
        inner.setAttribute('d', 'M0,-6 C18,-34 46,-34 60,-6 C46,8 18,8 0,-6 Z');
        inner.setAttribute('fill', colorSecondary);
        inner.setAttribute('opacity', '0.28');
        inner.setAttribute('transform', `rotate(${i * 72}) scale(0.6) translate(10,6)`);
        g.appendChild(inner);
      }

      const center = document.createElementNS(ns, 'circle');
      center.setAttribute('cx', '0');
      center.setAttribute('cy', '0');
      center.setAttribute('r', '12');
      center.setAttribute('fill', '#FFF7F9');
      center.setAttribute('stroke', colorPrimary);
      center.setAttribute('stroke-width', '2');

      const heart = document.createElementNS(ns, 'path');
      heart.setAttribute('d', 'M0,-2 C-6,-10 -20,-6 -20,2 C-20,14 0,22 0,22 C0,22 20,14 20,2 C20,-6 6,-10 0,-2 Z');
      heart.setAttribute('fill', colorPrimary);
      heart.setAttribute('transform', 'scale(0.35) translate(0,2)');
      heart.setAttribute('opacity', '0.95');

      g.appendChild(center);
      g.appendChild(heart);
      svg.appendChild(g);

      return svg;
    }

    function showFlowerPopup(text = "‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÜ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÜ‡πÄ‡πÄ‡∏ï‡πà‡πÄ‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏£‡∏µ‡∏ö‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏≤‡πÄ‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡πÄ‡∏•‡∏∞‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏ô‡∏∞‡πÄ‡∏ß‡πâ‡∏¢‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏ó‡∏µ‡πà‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡πÄ‡∏ó‡∏ô‡πÄ‡πÄ‡∏•‡∏∞‡∏∞‡∏â‡∏±‡∏ô‡∏£‡∏±‡∏Å‡πÄ‡πÄ‡∏Å‡∏°‡∏≤‡∏Å‡∏ô‡∏∞‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ß‡∏µ‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏Å‡πá‡πÄ‡∏ñ‡∏≠‡∏∞‡πÄ‡πÄ‡∏ï‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∏‡πâ‡∏ö‡πÜ‡∏ô‡∏∞‡∏à‡πâ‡∏∞‡∏≠‡∏µ‡∏≠‡πâ‡∏ß‡∏ô ‚ù§Ô∏è", options = {}) {
      const popup = document.getElementById('flowerPopup');
      const title = document.getElementById('flowerPopupText');
      const container = document.getElementById('flowerContainer');
      const count = options.count || 12;
      const palette = options.palette || [
        { primary: '#FF6F91', secondary: '#FFD6E0' },
        { primary: '#FF9AC1', secondary: '#FFE6F0' },
        { primary: '#FFB86B', secondary: '#FFEFD6' },
        { primary: '#9AD0F5', secondary: '#E8F7FF' }
      ];
      const autoCloseMs = typeof options.autoCloseMs === 'number' ? options.autoCloseMs : (5200 + count * 80);

      title.textContent = text;
      container.innerHTML = '';

      for (let i = 0; i < count; i++) {
        const wrapper = document.createElement('div');
        wrapper.className = 'flower-svg';
        const left = 6 + Math.random() * 88;
        wrapper.style.left = left + '%';
        const rot = -12 + Math.random() * 24;
        wrapper.style.transform = `translateY(0) scale(0.2) rotate(${rot}deg)`;
        const pal = palette[i % palette.length];
        const svg = createFlowerSVGElement(pal.primary, pal.secondary);
        wrapper.appendChild(svg);
        container.appendChild(wrapper);

        setTimeout(() => {
          wrapper.classList.add('show');
          if (Math.random() > 0.45) wrapper.classList.add('float');
          const petals = svg.querySelectorAll('path');
          petals.forEach((p, idx) => { p.style.transitionDelay = (idx * 20) + 'ms'; });
        }, 120 * i + Math.random() * 160);

        setTimeout(() => {
          wrapper.style.transition = 'opacity 0.9s, transform 0.9s';
          wrapper.style.opacity = '0';
          wrapper.style.transform += ' translateY(-40px) scale(.9)';
          setTimeout(() => wrapper.remove(), 900);
        }, autoCloseMs - 600 + i * 60);
      }

      popup.style.display = 'flex';
      popup.setAttribute('aria-hidden', 'false');

      // ensure music continues
      bgMusic.play().catch(()=>{});

      setTimeout(() => {
        closeFlowerPopup();
      }, autoCloseMs + 300);
    }

    function closeFlowerPopup(e) {
      const popup = document.getElementById('flowerPopup');
      popup.style.display = 'none';
      popup.setAttribute('aria-hidden', 'true');
      const container = document.getElementById('flowerContainer');
      container.innerHTML = '';
    }

    // Expose functions for manual testing
    window.showMemories = showMemories;
    window.showFlowerPopup = showFlowerPopup;
  </script>
</body>
</html>
